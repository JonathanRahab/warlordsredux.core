<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        html {
            visibility: hidden;
        }
    </style>
    <link rel="stylesheet" href="src\ui\style\squad.css">
    <link rel="stylesheet" href="src\ui\style\menu.css">
</head>

<body>
    <div class="menu-wrapper">
        <div class="menu-title">Squad</div>
        <div class="squad-menu">
            <div class="panel left-panel">
                <div class="create-squad-button-wrapper">
                    <button class="create-squad-button">+ Create Squad</button>
                </div>
                <div class="squads"></div>
            </div>

            <div class="panel right-panel"></div>

            <div class="rename-modal">
                <div class="rename-modal-content">
                    <h4>Rename Squad</h4>
                    <input type="text" id="squad-name-input" placeholder="Enter new squad name">
                    <button id="rename-squad-button">Rename</button>
                    <button id="cancel-rename-button">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <script src="src\ui\script\menu.js"></script>
    <script>
        document.querySelector('.create-squad-button').addEventListener('mousedown', function () {
            A3API.SendAlert('["create"]');
            document.querySelector('.create-squad-button-wrapper').classList.add('hide');
        });

        document.getElementById('cancel-rename-button').addEventListener('mousedown', () => {
            document.querySelector('.rename-modal').style.display = 'none';
        });

        function saveName() {
            document.querySelector('.rename-modal').style.display = 'none';
            const newName = document.getElementById('squad-name-input').value;
            const sanitizedName = newName.replace(/[^a-zA-Z0-9\s]/g, "").trim();
            if (!sanitizedName) {
                return;
            }
            A3API.SendAlert(`["renamed", ["${sanitizedName}"]]`);
        }

        document.getElementById('rename-squad-button').addEventListener('mousedown', () => {
            saveName();
        });

        function formatPoints(points) {
            if (points >= 1000000) {
                return (points / 1000000).toFixed(1) + "M pts";
            }
            if (points >= 1000) {
                return (points / 1000).toFixed(1) + "K pts";
            }
            return points + " pts";
        }

        function updateData(playerInfo, squadData) {
            playerInfo = JSON.parse(playerInfo || '{}');
            squadData = JSON.parse(squadData || '{}');

            const squadTemplate = document.querySelector('.squad.template');
            document.querySelector('.squads').innerHTML = '';

            const squaddedPlayers = [];
            let isInASquad = false;
            squadData.forEach(squad => {
                const squadEl = document.createElement('div');
                squadEl.classList.add('squad');

                const squadNameEl = document.createElement('h3');
                squadEl.appendChild(squadNameEl);
                document.querySelector('.squads').appendChild(squadEl);

                const isSquadLeader = squad[1] === playerInfo[0];
                const inCurrentSquad = squad[2].some(member => member[0] === playerInfo[0]);

                let squadPoints = 0;
                squad[2].forEach(member => {
                    const memberEl = document.createElement('div');
                    memberEl.classList.add('member');
                    memberEl.dataset.playerId = member[0];
                    memberEl.textContent = `${member[1]} (${formatPoints(member[2])})`;
                    squadEl.appendChild(memberEl);

                    squadPoints += member[2];

                    squaddedPlayers.push(member[0]);

                    const canFastTravel = member[3] === true;

                    if (member[0] === playerInfo[0]) {
                        isInASquad = true;

                        const leaveButton = document.createElement('button');
                        leaveButton.textContent = 'Leave';
                        leaveButton.classList.add('leave-button');
                        leaveButton.addEventListener('mousedown', function () {
                            A3API.SendAlert(`["leave"]`);
                        });
                        memberEl.appendChild(leaveButton);
                    } else if (isSquadLeader) {
                        const kickButton = document.createElement('button');
                        kickButton.textContent = 'Kick';
                        kickButton.classList.add('kick-button');
                        kickButton.addEventListener('mousedown', function () {
                            A3API.SendAlert(`["kick", ["${member[0]}"]]`);
                        });
                        memberEl.appendChild(kickButton);

                        const promoteButton = document.createElement('button');
                        promoteButton.textContent = 'Promote';
                        promoteButton.classList.add('promote-button');
                        promoteButton.addEventListener('mousedown', function () {
                            A3API.SendAlert(`["promote", ["${member[0]}"]]`);
                        });
                        memberEl.appendChild(promoteButton);

                        if (canFastTravel) {
                            const fastTravelButton = document.createElement('button');
                            fastTravelButton.textContent = 'Fast Travel';
                            fastTravelButton.classList.add('ft-button');
                            fastTravelButton.addEventListener('mousedown', function () {
                                A3API.SendAlert(`["ftSquad", ["${member[0]}"]]`);
                            });
                            memberEl.appendChild(fastTravelButton);
                        }
                    }

                    if (squad[1] === member[0]) {
                        memberEl.classList.add('squad-leader');
                        if (playerInfo[0] !== member[0] && inCurrentSquad && canFastTravel) {
                            const fastTravelButton = document.createElement('button');
                            fastTravelButton.textContent = 'Fast Travel';
                            fastTravelButton.classList.add('ft-button');
                            fastTravelButton.addEventListener('mousedown', function () {
                                A3API.SendAlert(`["ftSquadLeader", []]`);
                            });
                            memberEl.appendChild(fastTravelButton);
                        }
                    } else {
                        memberEl.classList.remove('squad-leader');
                    }
                });

                squadNameEl.textContent = `${squad[0]} (${formatPoints(squadPoints)})`;
                if (isSquadLeader) {
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit Squad Name';
                    editButton.classList.add('edit-button');
                    editButton.addEventListener('mousedown', function () {
                        const renameModalEl = document.querySelector('.rename-modal');
                        renameModalEl.style.display = 'flex';
                        setTimeout(() => {
                            const input = document.getElementById('squad-name-input');
                            input.focus();

                            input.addEventListener('keydown', function handler(e) {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    saveName();
                                    input.removeEventListener('keydown', handler);
                                }
                            });
                        }, 50);
                    });
                    squadNameEl.appendChild(editButton);
                }
            });

            if (isInASquad) {
                document.querySelector('.create-squad-button-wrapper').classList.add('hide');
            } else {
                document.querySelector('.create-squad-button-wrapper').classList.remove('hide');
            }

            const unsquaddedPlayers = playerInfo[1].filter(player => !squaddedPlayers.includes(player[0]) && player[0] !== playerInfo[0]);
            const rightPanel = document.querySelector('.right-panel');
            rightPanel.innerHTML = '';
            unsquaddedPlayers.forEach(player => {
                const playerEl = document.createElement('div');
                playerEl.classList.add('unsquadded-player');
                playerEl.dataset.playerId = player[0];
                rightPanel.appendChild(playerEl);

                const playerName = player[1] || "";
                const playerNameSpan = document.createElement('span');
                playerNameSpan.textContent = `${playerName} (${formatPoints(player[2])})`;
                playerEl.appendChild(playerNameSpan);

                if (isInASquad) {
                    const inviteButton = document.createElement('button');
                    inviteButton.textContent = 'Invite';
                    inviteButton.classList.add('invite-button');
                    inviteButton.addEventListener('mousedown', function () {
                        A3API.SendAlert(`["invite", ["${player[0]}"]]`);
                    });
                    playerEl.appendChild(inviteButton);
                }
            });
        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            var allStyles = document.getElementsByTagName("link");
            [...allStyles].forEach((link) => {
                if (link.href) {
                    const styleNode = document.createElement("style");
                    A3API.RequestFile(link.href).then(content => {
                        styleNode.innerHTML = content;
                        link.replaceWith(styleNode);
                    });
                }
            });

            const allScripts = document.getElementsByTagName("script");
            [...allScripts].forEach((script) => {
                if (script.src) {
                    A3API.RequestFile(script.src).then(content => {
                        const scriptNode = document.createElement("script");
                        scriptNode.innerHTML = content;
                        script.replaceWith(scriptNode);
                    });
                }
            });
        });
    </script>
</body>

</html>